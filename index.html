<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de Vídeo Monstro 5.2 (Definitivo)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Alerta de que a função de renderização de vídeo foi desativada por incompatibilidade
    var Whammy={Video:function(){},add:function(){},compile:function(){
        alert("Erro: A função de renderização de vídeo foi desativada por incompatibilidade de GPU. Use 'Exportar Rápido'."); 
    }};;
    
    // Capacitor JS Bridge
    const { Filesystem, Camera } = window.Capacitor ? window.Capacitor.Plugins : { Filesystem: null, Camera: null };
    const FFmpegPlugin = window.Capacitor ? (window.Capacitor.Plugins.FFmpegPlugin || null) : null;
    
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-1.5:generateContent";
    let GEMINI_API_KEY = ""; 

  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
    .tab-button.active { background-color: #8b5cf6; color: white; border-color: #8b5cf6; }
    .spinner { border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top:3px solid #a78bfa; width:18px; height:18px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% {transform:rotate(0)} 100% {transform:rotate(360deg)} }
    input[type="range"]{ -webkit-appearance:none; appearance:none; width:100%; height:8px; background:#4a5568; border-radius:5px; outline:none; }
    input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:24px; height:24px; background:#a78bfa; cursor:pointer; border-radius:50%; }
    select { background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position:right .5rem center; background-repeat:no-repeat; background-size:1.5em 1.5em; -webkit-appearance:none; -moz-appearance:none; appearance:none; }
    #render-overlay { transition: opacity .5s; backdrop-filter: blur(10px); }
    .vfx-button.active { background-color:#a78bfa; box-shadow:0 0 10px #a78bfa; }
    #dom-captions .cap { font-weight: 900; line-height: 1.05; text-shadow: 2px 2px 0 rgba(0,0,0,.6), 0 0 10px rgba(0,0,0,.5); word-break: break-word; }
    .vfx-shake { animation: shake-animation 0.1s infinite; }
    .vfx-chromatic { filter: hue-rotate(180deg) saturate(200%); }
    @keyframes shake-animation { 0%, 100% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">
  <header class="bg-gray-800 shadow-lg z-20">
    <div class="container mx-auto px-4 py-4">
      <h1 class="text-xl font-bold text-center text-violet-400">Editor de Vídeo Monstro 5.2 (Definitivo)</h1>
      <p class="text-center text-gray-400 mt-1 text-sm">Pronto para o Build Final</p>
    </div>
  </header>
  <main class="flex-grow container mx-auto p-2 flex flex-col">
    <div id="video-area" class="w-full bg-black flex items-center justify-center rounded-2xl shadow-2xl min-h-[30vh] relative overflow-hidden cursor-default">
      <div id="placeholder" class="text-center text-gray-500 flex flex-col items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
        <p class="text-xl mt-2">Aguardando vídeo...</p>
      </div>
      <video id="video-player" class="w-full h-auto max-h-[70vh] object-contain" crossorigin="anonymous" playsinline></video>
      <canvas id="canvas-player" class="hidden w-full h-auto max-h-[70vh] object-contain"></canvas>
      <div id="dom-captions" class="absolute inset-0 pointer-events-none flex items-end justify-center p-3 text-center"></div>
      <div id="render-overlay" class="hidden absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center z-50 text-center p-4">
        <h2 id="render-title" class="text-2xl font-bold text-violet-400 mb-4">A renderizar vídeo...</h2>
        <div class="w-3/4 bg-gray-600 rounded-full h-4"><div id="render-progress" class="bg-violet-500 h-4 rounded-full" style="width:0%"></div></div>
        <p id="render-message" class="text-sm mt-4 text-gray-300">Iniciando...</p>
        <button id="cancel-render-btn" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
      </div>
    </div>
    <div class="w-full bg-gray-800 p-4 mt-4 rounded-2xl shadow-2xl flex flex-col space-y-4 self-start">
      <div class="flex gap-3 items-center flex-wrap">
        <input type="file" id="video-upload-input" class="hidden" accept="video/*">
        <label id="load-video-btn" class="flex-grow inline-block bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-4 rounded-lg cursor-pointer text-center">Carregar Vídeo</label>
        <button id="export-fast-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg">Exportar Rápido (com áudio)</button>
        <button id="export-vfx-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Salvar Frame (Com VFX)</button>
        <button id="export-native-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-4 rounded-lg">✅ EXPORTAR VÍDEO FINAL (FFmpeg)</button>
      </div>
      <div id="controls-container" class="hidden flex flex-col space-y-4"></div>
    </div>
  </main>

  <script>
    // --- VARIÁVEIS ---
    const videoPlayer = document.getElementById('video-player');
    const exportNativeBtn = document.getElementById('export-native-btn');
    const renderOverlay = document.getElementById('render-overlay');
    const renderTitle = document.getElementById('render-title');
    const renderMessage = document.getElementById('render-message');
    const renderProgress = document.getElementById('render-progress');
    const loadVideoBtn = document.getElementById('load-video-btn');
    const videoUploadInput = document.getElementById('video-upload-input');
    const placeholder = document.getElementById('placeholder');
    const controlsContainer = document.getElementById('controls-container');
    // ... e todas as suas outras variáveis
    let originalVideoFile = null;
    let isRendering = false;

    // --- CÓDIGO DE LÓGICA ---

    // O endereço da sua "cozinha" no Replit
    const SERVER_URL = "https://72b56439-e24a-469a-8221-945e4a12fc84-00-1l76xt1xklt2a.picard.replit.dev/";

    // Lógica para carregar o vídeo com pedido de permissão
    loadVideoBtn.addEventListener('click', async () => {
        if (!Camera) { videoUploadInput.click(); return; }
        try {
            const status = await Camera.requestPermissions({ permissions: ['photos'] });
            if (status.photos === 'granted') {
                videoUploadInput.click();
            } else {
                alert("Para carregar um vídeo, você precisa permitir o acesso à sua galeria.");
            }
        } catch (erro) {
            console.error("Erro ao pedir permissão:", erro);
            videoUploadInput.click(); // Fallback
        }
    });

    videoUploadInput.addEventListener('change', event => {
        const file = event.target.files[0];
        if (!file) return;
        originalVideoFile = file;
        const fileURL = URL.createObjectURL(file);
        videoPlayer.src = fileURL;
        placeholder.classList.add('hidden');
        controlsContainer.classList.remove('hidden');
    });

    // Lógica do botão de exportação final (atualizada)
    exportNativeBtn.addEventListener('click', async () => {
        if (!originalVideoFile) {
            alert("Por favor, carregue um vídeo primeiro!");
            return;
        }
        
        isRendering = true;
        renderOverlay.classList.remove('hidden');
        renderTitle.textContent = "Enviando para a Cozinha...";
        renderMessage.textContent = "Preparando o seu vídeo...";
        renderProgress.style.width = '10%';

        const formData = new FormData();
        formData.append('videoFile', originalVideoFile);

        try {
            renderMessage.textContent = "Enviando vídeo para o servidor... Isso pode demorar.";
            renderProgress.style.width = '30%';

            const response = await fetch(`${SERVER_URL}upload`, {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                throw new Error(`O servidor respondeu com um erro: ${response.statusText}`);
            }

            renderMessage.textContent = "Servidor está processando o vídeo... Aguarde.";
            renderProgress.style.width = '70%';

            const result = await response.json();

            if (result.success) {
                renderProgress.style.width = '100%';
                renderTitle.textContent = "SUCESSO!";
                renderMessage.textContent = "O áudio foi extraído! Verifique os arquivos do seu servidor Replit.";
                
                // Futuramente, aqui teríamos o link para download
                alert(`Processamento concluído! Áudio salvo no servidor em: ${result.audioPath}`);

            } else {
                throw new Error(result.message || "O servidor encontrou um erro ao processar.");
            }

        } catch (error) {
            renderTitle.textContent = "ERRO NA COMUNICAÇÃO";
            renderMessage.textContent = `Não foi possível enviar o vídeo para a cozinha. Detalhes: ${error.message}`;
            console.error(error);
        }
        
        isRendering = false;
        setTimeout(() => { renderOverlay.classList.add('hidden'); }, 5000);
    });

    // ... cole aqui o RESTANTE do seu código JavaScript (funções de IA, captions, efeitos, etc.) ...
    // ... Ele não precisa de alteração para esta etapa.
  </script>
</body>
</html>
