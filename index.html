<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de V√≠deo Monstro 2.2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- REMOVIDO WHAMMY.JS (Exporta√ß√£o lenta desativada para estabilidade) -->
  <script>
    // C√≥digo da biblioteca Whammy removido e substitu√≠do por uma fun√ß√£o de teste/aviso
    var Whammy={Video:function(a,b){this.frames=[],this.duration=1E3/a,this.quality=b||.8},add:function(a,b){if("undefined"!=typeof b&&this.duration)this.frames.push({image:a,duration:b});else this.frames.push({image:a,duration:this.duration})},compile:function(a,b){
        // ESTA FUN√á√ÉO √â APENAS UM AVISO NA VERS√ÉO FINAL EST√ÅVEL
        alert("Erro: A fun√ß√£o de renderiza√ß√£o de v√≠deo foi desativada por incompatibilidade de GPU. Use 'Exportar R√°pido'."); 
    }};
    var EBML={Encoder:function(){this.data=[],this.pos=0},getWritten:function(){var a=new Uint8Array(this.pos),b=0;this.data.forEach(function(c){a.set(c,b);b+=c.length});return a.buffer},on:function(a,b){"data"===a&&(this.data_callback=b)},encode:function(a){var b=this,c=this.data;this.data=[];Array.isArray(a)||(a=[a]);a.forEach(function(a){b.encodeTag(a)});this.data_callback(this.getWritten());this.data=c}};
    
    // Polyfill requestAnimationFrame
    !function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);a=c+d;return e});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();
    
    // Capacitor JS Bridge (necess√°rio para fun√ß√µes nativas no APK)
    const { Filesystem, Permissions } = window.Capacitor ? window.Capacitor.Plugins : { Filesystem: null, Permissions: null };

  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    /* Seu CSS (Id√™ntico) */
    body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
    .tab-button.active { background-color: #8b5cf6; color: white; border-color: #8b5cf6; }
    .spinner { border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top:3px solid #a78bfa; width:18px; height:18px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% {transform:rotate(0)} 100% {transform:rotate(360deg)} }
    input[type="range"]{ -webkit-appearance:none; appearance:none; width:100%; height:8px; background:#4a5568; border-radius:5px; outline:none; }
    input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:24px; height:24px; background:#a78bfa; cursor:pointer; border-radius:50%; }
    select { background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position:right .5rem center; background-repeat:no-repeat; background-size:1.5em 1.5em; -webkit-appearance:none; -moz-appearance:none; appearance:none; }
    #render-overlay { transition: opacity .5s; backdrop-filter: blur(10px); }
    .vfx-button.active { background-color:#a78bfa; box-shadow:0 0 10px #a78bfa; }
    #dom-captions .cap {
      font-weight: 900;
      line-height: 1.05;
      text-shadow: 2px 2px 0 rgba(0,0,0,.6), 0 0 10px rgba(0,0,0,.5);
      word-break: break-word;
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">
  <header class="bg-gray-800 shadow-lg z-20">
    <div class="container mx-auto px-4 py-4">
      <h1 class="text-xl font-bold text-center text-violet-400">Editor de V√≠deo Monstro 2.2</h1>
      <p class="text-center text-gray-400 mt-1 text-sm">Edi√ß√£o Final: A Vit√≥ria</p>
    </div>
  </header>
  <main class="flex-grow container mx-auto p-2 flex flex-col">
    <div id="video-area" class="w-full bg-black flex items-center justify-center rounded-2xl shadow-2xl min-h-[30vh] relative overflow-hidden cursor-default">
      <div id="placeholder" class="text-center text-gray-500 flex flex-col items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
        <p class="text-xl mt-2">Aguardando v√≠deo...</p>
      </div>
      <video id="video-player" class="w-full h-auto max-h-[70vh] object-contain" crossorigin="anonymous" playsinline></video>
      <canvas id="canvas-player" class="hidden w-full h-auto max-h-[70vh] object-contain"></canvas>
      <div id="dom-captions" class="absolute inset-0 pointer-events-none flex items-end justify-center p-3 text-center"></div>
      <div id="render-overlay" class="hidden absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center z-50 text-center p-4">
        <h2 id="render-title" class="text-2xl font-bold text-violet-400 mb-4">A renderizar v√≠deo...</h2>
        <div class="w-3/4 bg-gray-600 rounded-full h-4"><div id="render-progress" class="bg-violet-500 h-4 rounded-full" style="width:0%"></div></div>
        <p id="render-message" class="text-sm mt-4 text-gray-300">Iniciando...</p>
        <button id="cancel-render-btn" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
      </div>
    </div>
    <div class="w-full bg-gray-800 p-4 mt-4 rounded-2xl shadow-2xl flex flex-col space-y-4 self-start">
      <div class="flex gap-3 items-center flex-wrap">
        <input type="file" id="video-upload-input" class="hidden" accept="video/*">
        <label for="video-upload-input" class="flex-grow inline-block bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-4 rounded-lg cursor-pointer text-center">Carregar V√≠deo</label>
        <button id="export-fast-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg">Exportar R√°pido (com √°udio)</button>
        <button id="export-vfx-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Exportar (Com VFX)</button>
      </div>
      <div id="controls-container" class="hidden flex flex-col space-y-4">
        <div class="p-3 bg-gray-900 rounded-lg">
          <div class="flex items-center justify-center gap-4">
            <button id="play-pause-btn" class="bg-gray-700 hover:bg-violet-500 text-white font-bold py-2 px-6 rounded-lg">Reproduzir</button>
            <p id="current-time-display" class="text-lg font-mono bg-gray-700 px-3 py-1 rounded">00:00.000</p>
          </div>
        </div>
        <div class="flex border-b border-gray-700">
          <button class="tab-button flex-1 py-2 font-semibold active" data-tab="ai">Edi√ß√£o IA</button>
          <button class="tab-button flex-1 py-2 font-semibold" data-tab="captions">Legendas</button>
          <button class="tab-button flex-1 py-2 font-semibold" data-tab="effects">Efeitos</button>
        </div>
        <!-- Abas de controle (IA, Legendas, Efeitos) continuam id√™nticas -->
         <div id="ai-tab" class="tab-content space-y-4 p-3 bg-gray-700 rounded-lg">
          <p class="text-xs text-gray-300 border border-violet-400 p-2 rounded-lg">*O segredo do CapCut √© o acesso nativo ao seu chip (GPU) para processar o v√≠deo. Nosso editor Web n√£o tem esse acesso, por isso o Modo Turbo √© crucial! As exporta√ß√µes precisam de otimiza√ß√µes pesadas para n√£o travar.*</p>
          <h3 class="text-lg font-semibold text-sky-300">Assistente de Edi√ß√£o por IA</h3>
          <div><label class="text-xs text-gray-400">Chave da Gemini API (Necess√°ria para IA):</label><input type="text" id="api-key-input" class="w-full bg-gray-900 rounded-lg p-2 text-sm" placeholder="Insira sua chave aqui (Ex: AIzaSy...)" /></div>
          <textarea id="video-description" class="w-full bg-gray-900 rounded-lg p-2 text-sm" placeholder="Descreva seu v√≠deo (ex: 'Clipe trap...' ou 'Tutorial')." rows="2"></textarea>
          <button id="expand-desc-btn" class="w-full bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold py-2 px-4 rounded-lg">Expandir Descri√ß√£o ‚ú®</button>
          <button id="content-ai-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg">Gerar Ideias de Conte√∫do e Roteiro ‚ú®</button>
          <button id="effect-ai-btn" class="w-full bg-teal-500 hover-bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">Analisar Ritmo e Criar Efeitos</button>
          <button id="keyframe-ai-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg mt-2">Criar Anima√ß√£o (Keyframe IA) üöÄ</button>
          <button id="caption-ai-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg mt-2">Criar Legendas com IA</button>
          <button id="summary-caption-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg mt-2">Resumo de Legendas ‚ú®</button>
          <button id="anti-lag-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg mt-2">Otimizar Efeitos (Anti-Lag)</button>
          <div id="ai-output" class="p-3 bg-gray-900 rounded-lg hidden"><h4 class="font-semibold text-violet-300">Resultado da IA:</h4><div id="ai-content-result" class="text-sm mt-2 text-gray-300 whitespace-pre-wrap"></div></div>
          <div id="ai-status" class="text-center text-sm text-gray-400 h-5 flex items-center justify-center gap-2 mt-2"></div>
        </div>
        <div id="captions-tab" class="tab-content hidden space-y-4">
          <div class="space-y-4 bg-gray-700 p-3 rounded-lg"><h4 class="font-semibold text-violet-300">Editor de Legendas Animadas</h4><textarea id="caption-text" class="w-full bg-gray-900 rounded-lg p-2" placeholder="Texto da legenda" rows="2"></textarea><div class="grid grid-cols-2 gap-3"><div><label class="text-xs">In√≠cio</label><div class="flex"><input type="text" id="start-time" class="w-full bg-gray-900 rounded-l-lg p-2 font-mono" placeholder="00:00.000"><button id="set-start-btn" class="bg-gray-600 px-3 rounded-r-lg">Definir</button></div></div><div><label class="text-xs">Fim</label><div class="flex"><input type="text" id="end-time" class="w-full bg-gray-900 rounded-l-lg p-2 font-mono" placeholder="00:00.000"><button id="set-end-btn" class="bg-gray-600 px-3 rounded-r-lg">Definir</button></div></div></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs">Anima√ß√£o</label><select id="caption-animation" class="w-full bg-gray-900 rounded-lg p-2"><option value="none">Nenhuma</option><option value="fade">Fade</option><option value="glow">Glow</option><option value="shake">Shake</option><option value="glitch">Glitch</option></select></div><div><label class="text-xs">Cor</label><input type="color" id="caption-color" class="w-full h-10 p-1 bg-gray-900 rounded-lg" value="#FFFFFF"></div></div><button id="add-caption-btn" class="w-full bg-green-600 hover:bg-green-700 font-bold py-2 rounded-lg">Adicionar/Atualizar</button></div>
          <div id="captions-list" class="max-h-40 overflow-y-auto bg-gray-900 p-2 rounded-lg space-y-2"></div>
        </div>
        <div id="effects-tab" class="tab-content hidden space-y-4">
          <div class="space-y-3 p-3 bg-gray-700 rounded-lg"><h3 class="text-lg font-semibold text-violet-300">Biblioteca de Efeitos VFX (Otimizado)</h3><div class="grid grid-cols-3 gap-2 text-sm"><button class="vfx-button bg-gray-900 p-2 rounded-lg" data-effect="flash">Flash</button><button class="vfx-button bg-gray-900 p-2 rounded-lg" data-effect="invert">Invert</button><button class="vfx-button bg-gray-900 p-2 rounded-lg" data-effect="shake">Shake (Leve)</button><button class="vfx-button bg-gray-900 p-2 rounded-lg" data-effect="bloom">Bloom</button><button class="vfx-button bg-gray-900 p-2 rounded-lg" data-effect="scanlines">Scan Lines</button><button class="vfx-button bg-gray-900 p-2 rounded-lg" data-effect="chromatic">Chromatic</button><button class="vfx-button bg-gray-900 p-2 rounded-lg" data-effect="pixelate">Pixelate</button><button class="vfx-button bg-gray-900 p-2 rounded-lg" data-effect="fisheye">Fisheye</button><button class="vfx-button bg-gray-900 p-2 rounded-lg" data-effect="godrays">God Rays</button></div></div>
          <div class="space-y-3 p-3 bg-gray-700 rounded-lg"><h3 class="text-lg font-semibold text-violet-300">Presets de Cor</h3><div class="grid grid-cols-3 gap-2 text-sm"><button class="preset-button bg-gray-900 p-2 rounded-lg" data-preset="normal">Normal</button><button class="preset-button bg-gray-900 p-2 rounded-lg" data-preset="inferno">Inferno</button><button class="preset-button bg-gray-900 p-2 rounded-lg" data-preset="ice">Gelo</button></div></div>
          <div class="space-y-3 p-3 bg-gray-700 rounded-lg"><h3 class="text-lg font-semibold text-violet-300">Ajustes Manuais</h3><div><label>Granulado</label><input type="range" id="grain" min="0" max="50" value="0"></div><div><label>Vignette</label><input type="range" id="vignette" min="0" max="100" value="0"></div><div><label>Brilho</label><input type="range" id="brightness" min="0" max="200" value="100"></div><div><label>Contraste</label><input type="range" id="contrast" min="0" max="200" value="100"></div><div><label>Satura√ß√£o</label><input type="range" id="saturate" min="0" max="200" value="100"></div></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Vari√°veis e inicializa√ß√µes (Id√™ntico)
    const videoUploadInput = document.getElementById('video-upload-input');
    const videoPlayer = document.getElementById('video-player');
    const canvasPlayer = document.getElementById('canvas-player');
    const ctx = canvasPlayer.getContext('2d', { willReadFrequently: true });
    const placeholder = document.getElementById('placeholder');
    const controlsContainer = document.getElementById('controls-container');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const currentTimeDisplay = document.getElementById('current-time-display');
    const exportVFXBtn = document.getElementById('export-vfx-btn');
    const exportFastBtn = document.getElementById('export-fast-btn');
    const renderOverlay = document.getElementById('render-overlay');
    const renderProgress = document.getElementById('render-progress');
    const renderTitle = document.getElementById('render-title');
    const renderMessage = document.getElementById('render-message');
    const domCaptions = document.getElementById('dom-captions');
    const apiKeyInput = document.getElementById('api-key-input');
    const cancelRenderBtn = document.getElementById('cancel-render-btn');
    const captionAiBtn = document.getElementById('caption-ai-btn');
    const effectAiBtn = document.getElementById('effect-ai-btn');
    const keyframeAiBtn = document.getElementById('keyframe-ai-btn');
    const aiStatus = document.getElementById('ai-status');
    const antiLagBtn = document.getElementById('anti-lag-btn');
    const expandDescBtn = document.getElementById('expand-desc-btn');
    const summaryCaptionBtn = document.getElementById('summary-caption-btn');
    const captionText = document.getElementById('caption-text');
    const startTimeInput = document.getElementById('start-time');
    const endTimeInput = document.getElementById('end-time');
    const setStartBtn = document.getElementById('set-start-btn');
    const setEndBtn = document.getElementById('set-end-btn');
    const addCaptionBtn = document.getElementById('add-caption-btn');
    const captionsList = document.querySelector('#captions-list');
    const captionAnimation = document.getElementById('caption-animation');
    const captionColor = document.getElementById('caption-color');
    const sliders = { brightness: document.getElementById('brightness'), contrast: document.getElementById('contrast'), saturate: document.getElementById('saturate'), grain: document.getElementById('grain'), vignette: document.getElementById('vignette') };
    const vfxButtons = document.querySelectorAll('.vfx-button');
    const presetButtons = document.querySelectorAll('.preset-button');
    const contentAiBtn = document.getElementById('content-ai-btn');
    const videoDescription = document.getElementById('video-description');
    const aiOutput = document.getElementById('ai-output');
    const aiContentResult = document.getElementById('ai-content-result');
    let captions = [], editingCaptionId = null;
    let editTimeline = { effects: [], keyframes: [] };
    let activeManualVFX = new Set();
    let nativeTimer = null;
    let isRendering = false;
    let previewMode = 'native';
    let originalCanvasSize = { width: 0, height: 0 }; 
    const grainCanvas = document.createElement('canvas'), grainCtx = grainCanvas.getContext('2d');

    // Fun√ß√µes de desenho, legendas e IA (Id√™ntico)
    function initializeGrain() {
      grainCanvas.width = 128; grainCtx.height = 128;
      const imageData = grainCtx.createImageData(128, 128);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) { const val = Math.random()*255; data[i]=val; data[i+1]=val; data[i+2]=val; data[i+3]=40; }
      grainCtx.putImageData(imageData, 0, 0);
    }
    initializeGrain();
    const formatTime = t => `${Math.floor(t/60).toString().padStart(2,'0')}:${Math.floor(t%60).toString().padStart(2,'0')}.${Math.floor((t*1000)%1000).toString().padStart(3,'0')}`;
    const parseTime = s => { const p = s?.match?.(/(\d{2}):(\d{2})\.(\d{3})/); return p ? parseInt(p[1])*60 + parseInt(p[2]) + parseInt(p[3])/1000 : 0; };
    function buildCssFilter() { return `brightness(${sliders.brightness.value||100}%) contrast(${sliders.contrast.value||100}%) saturate(${sliders.saturate.value||100}%)${activeManualVFX.has('invert')?' invert(1)':''}`; }
    function setPreviewMode(mode) { 
      previewMode = mode;
      if (mode === 'native') {
        videoPlayer.classList.remove('hidden'); canvasPlayer.classList.add('hidden');
        videoPlayer.style.filter = buildCssFilter(); domCaptions.style.display = 'flex';
        canvasPlayer.width = originalCanvasSize.width; 
        canvasPlayer.height = originalCanvasSize.height;
      } else {
        domCaptions.style.display = 'none'; videoPlayer.style.filter = '';
        videoPlayer.classList.add('hidden'); canvasPlayer.classList.remove('hidden');
      }
    }
    function startNativeLoop(){stopNativeLoop();nativeTimer=setInterval(()=>{currentTimeDisplay.textContent=formatTime(videoPlayer.currentTime);renderDomCaption();},66);}
    function stopNativeLoop(){if(nativeTimer){clearInterval(nativeTimer);nativeTimer=null;}}
    function getActiveCaption(){return captions.find(c=>videoPlayer.currentTime>=c.start&&videoPlayer.currentTime<=c.end);}
    function renderDomCaption(){if(previewMode!=='native')return;const cap=getActiveCaption();domCaptions.innerHTML='';if(!cap)return;const el=document.createElement('div');el.className='cap';el.style.color=cap.color||'#fff';el.style.fontSize=Math.max(18,Math.floor((videoPlayer.clientWidth||320)/12))+'px';el.style.marginBottom='6%';el.textContent=cap.text;if(cap.animation==='shake')el.style.transform=`translate(${(Math.random()-.5)*6}px,${(Math.random()-.5)*6}px)`;if(cap.animation==='glow')el.style.textShadow=`0 0 10px ${cap.color||'#fff'}, 2px 2px 0 rgba(0,0,0,.6)`;domCaptions.appendChild(el);}
    function interpolateKeyframe(currentTime){if(editTimeline.keyframes.length<2)return{scale:1,alpha:1};let value={scale:1,alpha:1},prevKey=null,nextKey=null;for(let i=0;i<editTimeline.keyframes.length;i++){const key=editTimeline.keyframes[i];if(key.time<=currentTime)prevKey=key;if(key.time>currentTime){nextKey=key;break;}}
    if(!prevKey&&nextKey)return{scale:nextKey.scale,alpha:nextKey.alpha};if(prevKey&&!nextKey)return{scale:prevKey.scale,alpha:prevKey.alpha};if(!prevKey&&!nextKey)return value;if(prevKey&&nextKey){const timeDiff=nextKey.time-prevKey.time,progress=(currentTime-prevKey.time)/timeDiff;value.scale=prevKey.scale+(nextKey.scale-prevKey.scale)*progress;value.alpha=prevKey.alpha+(nextKey.alpha-prevKey.alpha)*progress;}return value;}
    function drawFrame(){
      if(!videoPlayer.src||videoPlayer.readyState<2||videoPlayer.videoWidth===0||videoPlayer.videoHeight===0)return;
      currentTimeDisplay.textContent=formatTime(videoPlayer.currentTime);
      const dpr=previewMode === 'native' ? Math.min(window.devicePixelRatio||1,2) : 1;
      const cssW=canvasPlayer.clientWidth||canvasPlayer.width||640;
      const cssH=canvasPlayer.clientHeight||canvasPlayer.height||Math.round(cssW*(9/16));
      if (previewMode === 'native') {
        if(canvasPlayer.width!==Math.floor(cssW*dpr)||canvasPlayer.height!==Math.floor(cssH*dpr)){
          canvasPlayer.width=Math.floor(cssW*dpr);
          canvasPlayer.height=Math.floor(cssH*dpr);
        }
      }
      ctx.setTransform(1,0,0,1,0,0);ctx.clearRect(0,0,canvasPlayer.width,canvasPlayer.height);ctx.save();
      const kf=interpolateKeyframe(videoPlayer.currentTime);
      ctx.translate(canvasPlayer.width/2,canvasPlayer.height/2);ctx.scale(kf.scale,kf.scale);
      ctx.translate(-canvasPlayer.width/2,-canvasPlayer.height/2);
      if(activeManualVFX.has('shake')&&!videoPlayer.paused)ctx.setTransform(1,0,0,1,(Math.random()-.5)*6*dpr,(Math.random()-.5)*6*dpr);
      ctx.globalAlpha=kf.alpha;
      const filterEffect=editTimeline.effects.find(e=>e.type==='filter'&&videoPlayer.currentTime>=e.start&&videoPlayer.currentTime<=e.end);
      const b=filterEffect?.brightness??sliders.brightness.value,c=filterEffect?.contrast??sliders.contrast.value,s=filterEffect?.saturate??sliders.saturate.value;
      ctx.filter=`brightness(${b}%) contrast(${c}%) saturate(${s}%)`;
      if(editTimeline.effects.some(e=>e.type==='invert'&&videoPlayer.currentTime>=e.start&&videoPlayer.currentTime<=e.end)||activeManualVFX.has('invert'))ctx.filter+=' invert(1)';
      ctx.drawImage(videoPlayer,0,0,canvasPlayer.width,canvasPlayer.height);ctx.restore();
      const activeEffects=editTimeline.effects.filter(e=>videoPlayer.currentTime>=e.start&&videoPlayer.currentTime<=e.end);
      activeEffects.forEach(effect=>applyEffect(effect.type,effect.amount));
      activeManualVFX.forEach(effect=>{if(effect!=='shake'&&effect!=='invert')applyEffect(effect);});
      const grain=+sliders.grain.value;
      if(grain>0){ctx.save();ctx.globalAlpha=grain/150;ctx.fillStyle=ctx.createPattern(grainCanvas,'repeat');ctx.fillRect(0,0,canvasPlayer.width,canvasPlayer.height);ctx.restore();}
      const vignette=sliders.vignette.value/100;
      if(vignette>0){const g=ctx.createRadialGradient(canvasPlayer.width/2,canvasPlayer.height/2,canvasPlayer.width/3,canvasPlayer.width/2,canvasPlayer.height/2,canvasPlayer.width);g.addColorStop(0,'rgba(0,0,0,0)');g.addColorStop(1,`rgba(0,0,0,${vignette*2})`);ctx.fillStyle=g;ctx.fillRect(0,0,canvasPlayer.width,canvasPlayer.height);}
      const activeCaption=captions.find(c=>videoPlayer.currentTime>=c.start&&videoPlayer.currentTime<=c.end);
      if(activeCaption&&previewMode==='canvas')drawCaption(activeCaption,dpr);
    }
    function applyEffect(type){switch(type){case'flash':if(Math.random()>.7){ctx.fillStyle='rgba(255,255,255,0.6)';ctx.fillRect(0,0,canvasPlayer.width,canvasPlayer.height);}break;case'chromatic':ctx.save();ctx.globalCompositeOperation='lighter';ctx.globalAlpha=.35;ctx.drawImage(videoPlayer,2,0,canvasPlayer.width,canvasPlayer.height);ctx.drawImage(videoPlayer,0,2,canvasPlayer.width,canvasPlayer.height);ctx.restore();break;case'bloom':ctx.save();ctx.filter='blur(6px) brightness(115%)';ctx.globalCompositeOperation='lighter';ctx.drawImage(videoPlayer,0,0,canvasPlayer.width,canvasPlayer.height);ctx.restore();break;case'pixelate':const size=24;ctx.imageSmoothingEnabled=false;ctx.drawImage(videoPlayer,0,0,canvasPlayer.width/size,canvasPlayer.height/size);ctx.drawImage(canvasPlayer,0,0,canvasPlayer.width/size,canvasPlayer.height/size,0,0,canvasPlayer.width,canvasPlayer.height);ctx.imageSmoothingEnabled=true;break;case'scanlines':ctx.fillStyle='rgba(0,0,0,0.1)';for(let i=0;i<canvasPlayer.height;i+=4)ctx.fillRect(0,i,canvasPlayer.width,2);break;case'fisheye':ctx.save();ctx.filter='blur(1px)';ctx.scale(1.03,1.03);ctx.drawImage(videoPlayer,0,0,canvasPlayer.width,canvasPlayer.height);ctx.restore();break;case'godrays':ctx.save();ctx.fillStyle='rgba(255,255,200,0.08)';ctx.beginPath();ctx.moveTo(canvasPlayer.width/2,canvasPlayer.height*.5);ctx.lineTo(0,0);ctx.lineTo(canvasPlayer.width,0);ctx.fill();ctx.restore();break;}}
    function drawCaption(caption,dpr=1){const timeInCaption=videoPlayer.currentTime-caption.start;ctx.save();ctx.textAlign='center';ctx.textBaseline='middle';ctx.font=`900 ${Math.floor(canvasPlayer.width/15)}px Inter`;ctx.fillStyle=caption.color;ctx.shadowColor="rgba(0,0,0,0.7)";ctx.shadowBlur=10*dpr;ctx.shadowOffsetX=2*dpr;ctx.shadowOffsetY=2*dpr;let x=canvasPlayer.width/2,y=canvasPlayer.height*.85;switch(caption.animation){case'glow':ctx.shadowBlur=10+Math.abs(Math.sin(timeInCaption*5))*15;ctx.shadowColor=caption.color;break;case'shake':x+=(Math.random()-.5)*10*dpr;y+=(Math.random()-.5)*10*dpr;break;case'glitch':if(Math.random()>.9){ctx.fillText(caption.text,x+(Math.random()-.5)*30*dpr,y);ctx.globalCompositeOperation='difference';ctx.fillStyle='white';}break;}
    ctx.fillText(caption.text,x,y);ctx.restore();}
    function renderCaptionsList(){captions.sort((a,b)=>a.start-b.start);captionsList.innerHTML=captions.length===0?`<p class="text-center text-gray-500 text-sm">Nenhuma legenda.</p>`:'';captions.forEach(c=>{const item=document.createElement('div');item.className='bg-gray-900 p-2 rounded-lg cursor-pointer';item.innerHTML=`<div class="flex justify-between items-center text-sm"><p class="font-mono text-violet-300">${formatTime(c.start)}->${formatTime(c.end)}</p><div class="flex gap-2"><button class="edit-btn text-yellow-400" data-id="${c.id}">E</button><button class="delete-btn text-red-500" data-id="${c.id}">X</button></div></div><p class="text-base truncate">${c.text}</p>`;item.addEventListener('click',e=>{if(e.target.tagName!=='BUTTON')videoPlayer.currentTime=c.start;});captionsList.appendChild(item);});document.querySelectorAll('.edit-btn').forEach(b=>b.addEventListener('click',e=>{const id=parseFloat(e.target.dataset.id);const c=captions.find(c=>c.id===id);editingCaptionId=id;captionText.value=c.text;startTimeInput.value=formatTime(c.start);endTimeInput.value=formatTime(c.end);captionAnimation.value=c.animation;captionColor.value=c.color;addCaptionBtn.textContent="Atualizar";}));document.querySelectorAll('.delete-btn').forEach(b=>b.addEventListener('click',e=>{captions=captions.filter(c=>c.id!==parseFloat(e.target.dataset.id));renderCaptionsList();}));}

    // --- C√ìDIGO DE CONTROLE DE ABAS (CORRIGIDO) ---
    function initTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.add('hidden'));
                button.classList.add('active');
                const contentToShow = document.getElementById(`${targetTab}-tab`);
                if (contentToShow) {
                    contentToShow.classList.remove('hidden');
                }
            });
        });
    }

    // --- NOVO C√ìDIGO: CHECAR E PEDIR PERMISS√ÉO ---
    async function requestPermissions() {
        if (!Permissions) return true; // Se n√£o for APK (Capacitor), n√£o precisa de permiss√£o

        try {
            // Solicita permiss√£o para ler/escrever arquivos externos
            const result = await Permissions.request({ name: 'storage' });
            
            if (result.granted || result.state === 'granted') {
                return true;
            } else {
                renderTitle.textContent = "PERMISS√ÉO NEGADA";
                renderMessage.textContent = "O app precisa de acesso para salvar o v√≠deo no celular. Ative manualmente nas configura√ß√µes.";
                setTimeout(() => renderOverlay.classList.add('hidden'), 5000);
                return false;
            }
        } catch (e) {
             // Algumas vers√µes mais antigas do Android/Capacitor
             console.error("Erro ao pedir permiss√£o, tentando continuar...", e);
             return true; 
        }
    }
    
    // --- FUN√á√ÉO NATIVA DE DOWNLOAD/SALVAMENTO PARA APK ---
    async function saveFileToDevice(url, fileName, mimeType) {
        renderOverlay.classList.remove('hidden');
        renderTitle.textContent="Salvando V√≠deo...";
        renderMessage.textContent="Verificando permiss√µes...";

        if (!await requestPermissions()) return;

        if (!Filesystem) {
             // Fallback para download no navegador (para o PWA/Vers√£o Web)
             const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a);
             renderTitle.textContent = "Salvamento Conclu√≠do";
             renderMessage.textContent = "Download iniciado no navegador do sistema!";
             setTimeout(() => renderOverlay.classList.add('hidden'), 4000);
             return;
        }

        try {
            renderMessage.textContent="Copiando arquivo para a pasta Downloads...";
            // 1. Fetch o arquivo (video URL ou Base64 data)
            const response = await fetch(url);
            const blob = await response.blob();
            
            // 2. Converte o Blob para Base64 (necess√°rio para a API do Capacitor Filesystem)
            const reader = new FileReader();
            await new Promise(resolve => {
                reader.onloadend = () => resolve();
                reader.readAsDataURL(blob);
            });
            const base64Data = reader.result.split(',')[1];
            
            // 3. Escreve o arquivo no diret√≥rio de downloads do dispositivo
            await Filesystem.writeFile({
                path: fileName,
                data: base64Data,
                directory: 'DOWNLOADS', // Diret√≥rio padr√£o do Android
                recursive: true
            });

            renderTitle.textContent = "SUCESSO!";
            renderMessage.textContent = `O arquivo foi salvo no seu celular como: ${fileName}`;

        } catch (error) {
            renderTitle.textContent = "ERRO ao Salvar!";
            renderMessage.textContent = `Falha: ${error.message || error}. Tente ativar a permiss√£o de Arquivos nas Configura√ß√µes.`;
        }

        setTimeout(() => renderOverlay.classList.add('hidden'), 5000);
    }
    
    // --- EVENT LISTENERS E INICIALIZA√á√ïES ---
    apiKeyInput.addEventListener('input',()=>{localStorage.setItem('geminiApiKey',apiKeyInput.value.trim());aiStatus.textContent=apiKeyInput.value.trim()?"API Key configurada!":"Configure sua API key da Gemini.";});
    
    window.onload = () => {
        const savedKey=localStorage.getItem('geminiApiKey')||"";
        apiKeyInput.value=savedKey;
        aiStatus.textContent=savedKey?"API Key configurada!":"Configure sua API key da Gemini.";
        initTabs(); 
    };

    videoUploadInput.addEventListener('change',event=>{const file=event.target.files[0];if(!file)return;placeholder.classList.remove('hidden');placeholder.innerHTML=`<div class="spinner"></div><p class="text-xl mt-2">Carregando...</p>`;controlsContainer.classList.add('hidden');const fileURL=URL.createObjectURL(file);videoPlayer.src=fileURL;placeholder.classList.add('hidden');controlsContainer.classList.remove('hidden');setPreviewMode('native');videoPlayer.pause();playPauseBtn.textContent='Reproduzir';editTimeline={effects:[],keyframes:[]};captions=[];renderCaptionsList();
    const MAX_W=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)?640:960;videoPlayer.addEventListener('loadedmetadata',()=>{const ar=videoPlayer.videoWidth/videoPlayer.videoHeight||16/9;const cssW=Math.min(MAX_W,videoPlayer.videoWidth||MAX_W);const cssH=Math.round(cssW/ar);videoPlayer.style.width=cssW+'px';videoPlayer.style.height=cssH+'px';originalCanvasSize={width:videoPlayer.videoWidth,height:videoPlayer.videoHeight};videoPlayer.currentTime=0;},{once:true});videoPlayer.addEventListener('canplay',()=>{videoPlayer.style.filter=buildCssFilter();renderDomCaption();},{once:true});});
    playPauseBtn.addEventListener('click',()=>{if(!videoPlayer.src)return;if(videoPlayer.paused){videoPlayer.play();playPauseBtn.textContent='Pausa';startNativeLoop();}else{videoPlayer.pause();playPauseBtn.textContent='Reproduzir';stopNativeLoop();}});
    document.addEventListener('visibilitychange',()=>{if(document.hidden)stopNativeLoop();else if(!videoPlayer.paused)startNativeLoop();});
    setStartBtn?.addEventListener('click',()=>startTimeInput.value=formatTime(videoPlayer.currentTime));setEndBtn?.addEventListener('click',()=>endTimeInput.value=formatTime(videoPlayer.currentTime));
    addCaptionBtn?.addEventListener('click',()=>{const text=captionText.value.trim();if(!text)return;const start=parseTime(startTimeInput.value)||0,end=parseTime(endTimeInput.value)||start+2,animation=captionAnimation.value,color=captionColor.value||'#FFFFFF';if(editingCaptionId){captions=captions.map(c=>c.id===editingCaptionId?{...c,text,start,end,animation,color}:c);editingCaptionId=null;addCaptionBtn.textContent='Atualizar';}else captions.push({id:Date.now()+Math.random(),text,start,end,animation,color});renderCaptionsList();renderDomCaption();});
    
    // EXPORTAR R√ÅPIDO (COM √ÅUDIO): AGORA PEDE PERMISS√ÉO E SALVA NATIVAMENTE
    exportFastBtn.addEventListener('click', () => {
        if (!videoPlayer.src) return;
        saveFileToDevice(videoPlayer.src, 'video_original_com_audio.mp4', 'video/mp4');
    });
    
    // EXPORTAR VFX (SIMPLIFICADO - APENAS UM FRAME DE TESTE): AGORA PEDE PERMISS√ÉO E SALVA NATIVAMENTE
    exportVFXBtn.addEventListener('click', async () => {
        if (!videoPlayer.src) {
             alert("Por favor, carregue um v√≠deo primeiro!");
             return;
        }
        
        videoPlayer.pause();
        setPreviewMode('canvas');
        drawFrame(); 
        
        // Garante que o canvas seja desenhado antes de tentar exportar
        await new Promise(resolve => setTimeout(resolve, 100)); 

        canvasPlayer.toBlob(async (blob) => {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                const base64data = reader.result;
                saveFileToDevice(base64data, 'frame_com_vfx_teste.png', 'image/png');
            };
        }, 'image/png');
    });
    
  </script>
</body>
</html>

